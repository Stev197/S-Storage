<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VAULT DATA PENTING</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== CSS SAMA PERSIS DENGAN ASLINYA ========== */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.8);
            --accent: #3b82f6;
            --accent-hover: #60a5fa;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #06b6d4;
            --crypto-gold: #FFD700;
            --crypto-silver: #C0C0C0;
            --crypto-bronze: #CD7F32;
            --crypto-bitcoin: #F7931A;
            --crypto-ethereum: #627EEA;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            --glass: rgba(255, 255, 255, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        html { font-size: 16px; height: 100%; }
        body {
            margin: 0; padding: 0; overflow-x: hidden; min-height: 100vh;
            background: var(--bg-primary); color: var(--text-primary);
        }

        /* background kripto (sama) */
        .crypto-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); }
        .crypto-particle { position: absolute; width: 20px; height: 20px; background: radial-gradient(circle at 30% 30%, var(--crypto-gold), transparent); border-radius: 50%; box-shadow: 0 0 10px var(--crypto-gold), inset 0 0 5px rgba(255,215,0,0.5); filter: blur(1px); animation: float 25s infinite linear; opacity: 0.6; }
        .crypto-particle:nth-child(odd) { background: radial-gradient(circle at 30% 30%, var(--crypto-bitcoin), transparent); box-shadow: 0 0 10px var(--crypto-bitcoin), inset 0 0 5px rgba(247,147,26,0.5); }
        .crypto-particle:nth-child(3n) { background: radial-gradient(circle at 30% 30%, var(--crypto-ethereum), transparent); box-shadow: 0 0 10px var(--crypto-ethereum), inset 0 0 5px rgba(98,126,234,0.5); }
        .crypto-particle:nth-child(4n) { background: radial-gradient(circle at 30% 30%, var(--crypto-silver), transparent); box-shadow: 0 0 10px var(--crypto-silver), inset 0 0 5px rgba(192,192,192,0.5); }
        .crypto-particle:nth-child(5n) { background: radial-gradient(circle at 30% 30%, var(--crypto-bronze), transparent); box-shadow: 0 0 10px var(--crypto-bronze), inset 0 0 5px rgba(205,127,50,0.5); }
        @keyframes float { 0% { transform: translateY(100vh) rotate(0deg); } 100% { transform: translateY(-100vh) rotate(360deg); } }
        .blur-effect { position: fixed; width: 200%; height: 200%; top: -50%; left: -50%; background: radial-gradient(circle at 20% 50%, rgba(59,130,246,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(139,92,246,0.1) 0%, transparent 50%), radial-gradient(circle at 40% 80%, rgba(247,147,26,0.1) 0%, transparent 50%); animation: blurMove 60s infinite alternate ease-in-out; filter: blur(40px); z-index: -2; }
        @keyframes blurMove { 0% { transform: translate(0%,0%) rotate(0deg); } 33% { transform: translate(-5%,5%) rotate(120deg); } 66% { transform: translate(5%,-5%) rotate(240deg); } 100% { transform: translate(0%,0%) rotate(360deg); } }

        /* login (sama) */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 16px; position: relative; z-index: 1; width: 100%; }
        .login-box { background: rgba(30,41,59,0.85); backdrop-filter: blur(12px); border-radius: 20px; padding: 32px 24px; width: 100%; max-width: 400px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.05), inset 0 1px 0 rgba(255,255,255,0.1); animation: loginSlideUp 0.6s ease-out; position: relative; overflow: hidden; }
        .login-box::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--crypto-bitcoin), var(--crypto-ethereum), var(--crypto-gold)); }
        .login-header { text-align: center; margin-bottom: 32px; }
        .login-logo { font-size: 2.8rem; margin-bottom: 16px; display: inline-block; background: linear-gradient(135deg, var(--crypto-gold), var(--crypto-bitcoin)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 8px rgba(255,215,0,0.3)); }
        .login-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, #f1f5f9, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.3; }
        .login-subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 24px; }
        .login-form { display: flex; flex-direction: column; gap: 20px; }
        .form-group { position: relative; }
        .form-label { display: block; margin-bottom: 6px; color: var(--text-primary); font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        .form-input { width: 100%; padding: 14px; background: rgba(15,23,42,0.7); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease; outline: none; -webkit-appearance: none; }
        .form-input:focus { border-color: var(--crypto-gold); box-shadow: 0 0 0 3px rgba(255,215,0,0.15); background: rgba(15,23,42,0.9); }
        .password-toggle { position: absolute; right: 12px; top: 40px; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; transition: color 0.3s ease; padding: 8px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; }
        .password-toggle:hover { color: var(--crypto-gold); background: rgba(255,255,255,0.05); }
        .login-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--crypto-bitcoin), var(--crypto-gold)); border: none; border-radius: 10px; color: white; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px; box-shadow: 0 4px 12px rgba(247,147,26,0.3); min-height: 52px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(247,147,26,0.4); background: linear-gradient(135deg, var(--crypto-gold), var(--crypto-bitcoin)); }
        .login-footer { text-align: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); font-size: 0.85rem; }
        .login-error { background: rgba(239,68,68,0.2); border: 1px solid var(--danger); color: var(--danger); padding: 12px; border-radius: 8px; margin-top: 16px; text-align: center; font-size: 0.85rem; animation: fadeIn 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 6px; }

        /* main app */
        .main-app { display: none; min-height: 100vh; position: relative; width: 100%; }
        .main-app.active { display: block; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 16px; }
        header { text-align: center; margin-bottom: 24px; padding: 16px 0; }
        header h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 8px; background: linear-gradient(90deg, var(--accent), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; position: relative; line-height: 1.3; padding: 0 8px; }
        header h1::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 80px; height: 3px; background: linear-gradient(90deg, var(--accent), #8b5cf6); border-radius: 2px; }
        .stats-container { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); backdrop-filter: blur(10px); border-radius: 14px; padding: 20px 16px; border: 1px solid var(--glass); transition: all 0.3s ease; text-align: center; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--accent), #8b5cf6); }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px var(--shadow); border-color: rgba(59,130,246,0.3); }
        .stat-icon { font-size: 1.8rem; color: var(--accent); background: rgba(59,130,246,0.1); width: 60px; height: 60px; line-height: 60px; border-radius: 50%; margin: 0 auto 12px; }
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); text-shadow: 0 2px 4px rgba(0,0,0,0.2); line-height: 1.2; }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* form */
        .form-container { background: var(--bg-card); backdrop-filter: blur(10px); border-radius: 14px; padding: 20px; margin-bottom: 24px; border: 1px solid var(--glass); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
        .form-title { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: var(--accent); }
        .form-title h2 { font-size: 1.3rem; font-weight: 600; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--accent); font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        input, textarea { width: 100%; padding: 14px; background: rgba(15,23,42,0.7); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease; outline: none; -webkit-appearance: none; }
        input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.2); background: rgba(15,23,42,0.9); }
        textarea { min-height: 150px; resize: vertical; font-family: 'Monaco','Menlo','Ubuntu Mono',monospace; line-height: 1.5; }
        .char-count { text-align: right; font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
        .form-actions { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .btn { padding: 14px 20px; border: none; border-radius: 10px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; flex: 1; min-height: 48px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #8b5cf6); color: white; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
        .btn-primary:hover { background: linear-gradient(135deg, var(--accent-hover), #9d7cf8); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(59,130,246,0.4); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; box-shadow: 0 4px 12px rgba(239,68,68,0.3); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); color: white; box-shadow: 0 4px 12px rgba(245,158,11,0.3); }
        .btn-info { background: linear-gradient(135deg, var(--info), #0891b2); color: white; box-shadow: 0 4px 12px rgba(6,182,212,0.3); }

        /* notes list */
        .notes-header { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .notes-header h2 { font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .notes-count { background: linear-gradient(135deg, var(--accent), #8b5cf6); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; width: fit-content; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
        #notesList { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 32px; }
        .note-card { background: var(--bg-card); backdrop-filter: blur(10px); border-radius: 14px; padding: 20px; border: 1px solid var(--glass); transition: all 0.3s ease; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .note-card::before { content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; background: linear-gradient(to bottom, var(--accent), #8b5cf6); }
        .note-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px var(--shadow); border-color: rgba(59,130,246,0.3); }
        .note-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 12px; color: var(--text-primary); word-break: break-word; padding-left: 10px; }
        .note-content { color: var(--text-secondary); margin-bottom: 16px; flex-grow: 1; word-break: break-word; overflow: hidden; line-height: 1.6; max-height: 100px; position: relative; padding-left: 10px; font-size: 0.95rem; }
        .note-content::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 30px; background: linear-gradient(transparent, var(--bg-card)); }
        .note-date { font-size: 0.8rem; color: #94a3b8; margin-bottom: 16px; display: flex; align-items: center; gap: 6px; padding-left: 10px; }
        .note-actions { display: flex; flex-direction: column; gap: 8px; margin-top: auto; }
        .note-actions .btn { padding: 10px; font-size: 0.9rem; border-radius: 8px; min-height: 44px; }

        /* modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; padding: 16px; animation: fadeIn 0.3s ease; overflow-y: auto; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-card); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--glass); box-shadow: 0 20px 40px rgba(0,0,0,0.5); animation: modalSlideIn 0.4s ease; position: relative; }
        .modal-content::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, var(--accent), #8b5cf6); border-radius: 16px 16px 0 0; }
        .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.3rem; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 10px; line-height: 1.4; word-break: break-word; flex: 1; margin-right: 10px; }
        .close-modal { background: none; border: none; color: var(--text-secondary); font-size: 1.8rem; cursor: pointer; transition: color 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; }
        .close-modal:hover { color: var(--danger); background: rgba(239,68,68,0.1); }
        .modal-body { margin-bottom: 20px; }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border); }

        /* loading & empty */
        .loading, .empty-state, .error-state { text-align: center; padding: 40px 16px; grid-column: 1 / -1; }
        .loading i { font-size: 2.5rem; color: var(--accent); margin-bottom: 16px; animation: pulse 1.5s infinite; }
        .empty-state i, .error-state i { font-size: 3rem; color: var(--text-secondary); margin-bottom: 16px; opacity: 0.7; }
        .error-state i { color: var(--danger); }

        /* logout */
        .logout-btn { position: fixed; top: 16px; right: 16px; background: rgba(239,68,68,0.2); border: 1px solid var(--danger); color: var(--danger); padding: 10px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; transition: all 0.3s ease; z-index: 100; font-size: 0.9rem; min-height: 44px; backdrop-filter: blur(10px); }
        .logout-btn:hover { background: var(--danger); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(239,68,68,0.3); }

        /* toast */
        .toast { position: fixed; bottom: 16px; right: 16px; left: 16px; background: var(--success); color: white; padding: 14px 20px; border-radius: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1001; animation: slideUp 0.3s ease; max-width: 400px; margin: 0 auto; }
        .toast.hidden { animation: slideDown 0.3s ease forwards; }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }

        /* animasi */
        @keyframes loginSlideUp { from { opacity:0; transform:translateY(40px) scale(0.95); } to { opacity:1; transform:translateY(0) scale(1); } }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        @keyframes pulse { 0% { transform:scale(1); } 50% { transform:scale(1.05); } 100% { transform:scale(1); } }
        @keyframes modalSlideIn { from { opacity:0; transform:translateY(-40px) scale(0.95); } to { opacity:1; transform:translateY(0) scale(1); } }
        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes slideDown { from { opacity:1; transform:translateY(0); } to { opacity:0; transform:translateY(20px); } }

        /* scroll */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--accent), #8b5cf6); border-radius: 4px; }

        /* responsive (sama) */
        @media (min-width: 600px) { .stats-container { grid-template-columns: repeat(2,1fr); } .form-actions { flex-direction: row; } #notesList { grid-template-columns: repeat(2,1fr); } }
        @media (min-width: 768px) { .stats-container { grid-template-columns: repeat(3,1fr); } }
        @media (min-width: 1024px) { #notesList { grid-template-columns: repeat(3,1fr); } }

        /* tambahan gambar */
        .note-image-thumb { margin: 10px 0 10px 10px; max-width: 100%; border-radius: 6px; max-height: 100px; object-fit: cover; border: 1px solid var(--border); }
        .modal-image-large { max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border); }
        #imagePreviewContainer { margin-top: 10px; position: relative; display: none; }
        #imagePreview { max-width: 100%; max-height: 150px; border-radius: 8px; border: 1px solid var(--border); }
        #removeImageBtn { position: absolute; top: 5px; right: 5px; padding: 5px 10px; min-height: auto; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="crypto-background" id="cryptoBackground"><div class="blur-effect"></div></div>

    <!-- LOGIN -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo pulse-animation"><i class="fas fa-coins"></i></div>
                <h1 class="login-title">Vault Data Penting</h1>
                <p class="login-subtitle">Akses aman + media gambar</p>
            </div>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="username" class="form-label"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" class="form-input" placeholder="Masukkan username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password" class="form-label"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Masukkan password" required autocomplete="current-password">
                    <button type="button" class="password-toggle" id="togglePassword"><i class="fas fa-eye"></i></button>
                </div>
                <button type="submit" class="login-btn"><i class="fas fa-unlock-alt"></i> Masuk ke Vault</button>
                <div class="login-footer"><p><i class="fas fa-shield-alt"></i> Data + gambar dienkripsi</p></div>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="main-app" id="mainApp">
        <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        <div class="container">
            <header><h1><i class="fas fa-vault"></i> Vault DATA PENTING</h1></header>

            <!-- stats -->
            <section class="stats-container">
                <div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div><div class="stat-value" id="activeUsers">1</div><div class="stat-label">Pengguna Aktif</div></div>
                <div class="stat-card"><div class="stat-icon"><i class="fas fa-eye"></i></div><div class="stat-value" id="totalVisits">1</div><div class="stat-label">Total Kunjungan</div></div>
                <div class="stat-card"><div class="stat-icon"><i class="fas fa-sticky-note"></i></div><div class="stat-value" id="totalNotes">0</div><div class="stat-label">Total Catatan</div></div>
            </section>

            <!-- form catatan + GAMBAR (TANPA BATAS KARAKTER) -->
            <section class="form-container">
                <div class="form-title"><i class="fas fa-plus-circle" id="formIcon"></i><h2 id="formTitle">Tambah Catatan Baru</h2></div>
                <input type="hidden" id="editingNoteId">
                
                <div class="form-group">
                    <label for="noteTitle"><i class="fas fa-heading"></i> Judul Catatan</label>
                    <input type="text" id="noteTitle" placeholder="Masukkan judul catatan...">
                    <div class="char-count"><span id="titleCharCount">0</span> karakter</div>
                </div>
                
                <div class="form-group">
                    <label for="noteContent"><i class="fas fa-sticky-note"></i> Isi Catatan (teks/kode)</label>
                    <textarea id="noteContent" placeholder="Tulis catatan, kode, atau link penting..."></textarea>
                    <div class="char-count"><span id="contentCharCount">0</span> karakter</div>
                </div>

                <!-- BAGIAN GAMBAR -->
                <div class="form-group">
                    <label for="noteImage"><i class="fas fa-image"></i> Gambar (opsional, maks 5MB)</label>
                    <input type="file" id="noteImage" accept="image/*">
                    <div id="imagePreviewContainer">
                        <img id="imagePreview" src="#" alt="Preview">
                        <button type="button" id="removeImageBtn" class="btn btn-danger"><i class="fas fa-times"></i> Hapus</button>
                    </div>
                </div>

                <div class="form-actions">
                    <button id="saveBtn" class="btn btn-primary"><i class="fas fa-save"></i> Simpan</button>
                    <button id="cancelEditBtn" class="btn btn-danger" style="display: none;"><i class="fas fa-times"></i> Batal</button>
                    <button id="clearFormBtn" class="btn"><i class="fas fa-broom"></i> Bersihkan</button>
                </div>
            </section>

            <!-- Daftar catatan -->
            <section>
                <div class="notes-header"><h2><i class="fas fa-clipboard-list"></i> Catatan Tersimpan</h2><div class="notes-count" id="notesCount">0 catatan</div></div>
                <div id="notesList"><div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Memuat catatan dari database...</p></div></div>
            </section>
        </div>

        <!-- MODAL LIHAT DETAIL + GAMBAR -->
        <div id="viewNoteModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-file-alt"></i> <span id="modalNoteTitle"></span></h3>
                    <button class="close-modal" id="closeModalBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Isi Catatan</label>
                        <div id="modalNoteContent" style="background: rgba(15,23,42,0.6); border:1px solid var(--border); border-radius:10px; padding:16px; max-height:200px; overflow-y:auto; white-space:pre-wrap; word-break:break-word; font-family:monospace; line-height:1.6;"></div>
                    </div>
                    <!-- GAMBAR DI MODAL -->
                    <div id="modalImageContainer" style="margin-top:20px; display:none;">
                        <label><i class="fas fa-image"></i> Gambar</label>
                        <img id="modalImage" src="#" alt="Gambar Catatan" class="modal-image-large">
                    </div>
                    <div class="form-group">
                        <label><i class="far fa-calendar"></i> Informasi</label>
                        <div style="display:grid; grid-template-columns:1fr; gap:12px;">
                            <div style="background:rgba(15,23,42,0.6); border:1px solid var(--border); border-radius:10px; padding:12px;">
                                <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:6px;"><i class="fas fa-calendar-plus"></i> Dibuat</div>
                                <div id="modalCreatedAt" style="font-weight:600; font-size:0.9rem;"></div>
                            </div>
                            <div style="background:rgba(15,23,42,0.6); border:1px solid var(--border); border-radius:10px; padding:12px;">
                                <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:6px;"><i class="fas fa-calendar-check"></i> Diubah</div>
                                <div id="modalUpdatedAt" style="font-weight:600; font-size:0.9rem;"></div>
                            </div>
                            <div style="background:rgba(15,23,42,0.6); border:1px solid var(--border); border-radius:10px; padding:12px;">
                                <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:6px;"><i class="fas fa-id-card"></i> ID</div>
                                <div id="modalNoteId" style="font-weight:600; font-size:0.85rem; word-break:break-all;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button id="editFromModalBtn" class="btn btn-warning"><i class="fas fa-edit"></i> Edit</button>
                    <button id="copyModalBtn" class="btn btn-success"><i class="far fa-copy"></i> Salin Teks</button>
                    <button id="closeModalBtn2" class="btn"><i class="fas fa-times"></i> Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast hidden"><i class="fas fa-check-circle"></i><span id="toastMessage">Berhasil</span></div>

    <script type="module">
        // ==================== SETUP BACKGROUND & LOGIN (sama persis) ====================
        function generateCryptoParticles() {
            const container = document.getElementById('cryptoBackground');
            const particleCount = window.innerWidth < 768 ? 15 : 25;
            while (container.children.length > 1) container.removeChild(container.lastChild);
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'crypto-particle';
                const size = (window.innerWidth < 768 ? 15 : 25) + Math.random() * 15;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `-${Math.random() * 25}s`;
                particle.style.width = `${size}px`; particle.style.height = `${size}px`;
                container.appendChild(particle);
            }
        }
        function setupPasswordToggle() {
            const toggle = document.getElementById('togglePassword');
            const pass = document.getElementById('password');
            if (toggle && pass) toggle.addEventListener('click', () => {
                const type = pass.getAttribute('type') === 'password' ? 'text' : 'password';
                pass.setAttribute('type', type);
                toggle.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });
        }
        function setupLogin() {
            const loginForm = document.getElementById('loginForm');
            const loginContainer = document.getElementById('loginContainer');
            const mainApp = document.getElementById('mainApp');
            if (!loginForm) return;
            const isLoggedIn = localStorage.getItem('cryptoVaultLoggedIn') === 'true';
            const savedUsername = localStorage.getItem('cryptoVaultUsername');
            if (isLoggedIn && savedUsername) { showMainApp(savedUsername); return; }
            const handleLogin = (e) => {
                e?.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                if (!username || !password) { showLoginError('Harap isi username dan password'); return; }
                if ((username === 'Stev1' && password === 'Stev1') || (username === 'admin' && password === 'admin123')) {
                    localStorage.setItem('cryptoVaultLoggedIn', 'true');
                    localStorage.setItem('cryptoVaultUsername', username);
                    showMainApp(username);
                } else { showLoginError('Username atau password salah'); }
            };
            loginForm.addEventListener('submit', handleLogin);
        }
        function showMainApp(username) {
            const loginContainer = document.getElementById('loginContainer');
            const mainApp = document.getElementById('mainApp');
            if (!loginContainer || !mainApp) return;
            const headerTitle = document.querySelector('header h1');
            if (headerTitle) {
                const old = headerTitle.querySelector('.username-display');
                if (old) old.remove();
                const span = document.createElement('span');
                span.className = 'username-display';
                span.style.cssText = 'display:inline-block; margin-left:10px; font-size:0.8em; background:var(--crypto-bitcoin); color:white; padding:4px 10px; border-radius:20px; vertical-align:middle;';
                span.innerHTML = `<i class="fas fa-user"></i> ${username}`;
                headerTitle.appendChild(span);
            }
            loginContainer.style.opacity = '0';
            loginContainer.style.transition = 'opacity 0.3s ease';
            setTimeout(() => {
                loginContainer.style.display = 'none';
                mainApp.classList.add('active');
                mainApp.style.animation = 'fadeIn 0.5s ease forwards';
                initializeApp(); // init firebase
            }, 300);
        }
        function showLoginError(message) {
            let errorMsg = document.querySelector('.login-error');
            if (!errorMsg) {
                errorMsg = document.createElement('div');
                errorMsg.className = 'login-error';
                document.getElementById('loginForm')?.appendChild(errorMsg);
            }
            errorMsg.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            setTimeout(() => { if (errorMsg.parentNode) errorMsg.remove(); }, 4000);
        }
        function setupLogout() {
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                if (window.confirm('Apakah Anda yakin ingin logout?')) {
                    localStorage.removeItem('cryptoVaultLoggedIn');
                    localStorage.removeItem('cryptoVaultUsername');
                    location.reload();
                }
            });
        }

        // ==================== FIREBASE + FITUR GAMBAR ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBcixy1PyYTi_krRYUmz8LcvHHxtN5o92w",
            authDomain: "data-penting-c2e60.firebaseapp.com",
            projectId: "data-penting-c2e60",
            storageBucket: "data-penting-c2e60.firebasestorage.app",
            messagingSenderId: "805016544678",
            appId: "1:805016544678:web:aaeb2bef3d6db7786f1b67"
        };

        let app, db, storageInstance, notesCollection;
        let cleanupFunctions = [];
        let currentViewingNote = null;
        let isEditing = false;
        let selectedImageFile = null;
        let currentImageURL = null;

        // DOM elements
        const noteTitleInput = document.getElementById('noteTitle');
        const noteContentInput = document.getElementById('noteContent');
        const noteImageInput = document.getElementById('noteImage');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const removeImageBtn = document.getElementById('removeImageBtn');
        const saveBtn = document.getElementById('saveBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const editingNoteIdInput = document.getElementById('editingNoteId');
        const formTitle = document.getElementById('formTitle');
        const formIcon = document.getElementById('formIcon');
        const notesList = document.getElementById('notesList');
        const notesCount = document.getElementById('notesCount');
        const totalNotesElement = document.getElementById('totalNotes');
        const activeUsersElement = document.getElementById('activeUsers');
        const totalVisitsElement = document.getElementById('totalVisits');
        const titleCharCount = document.getElementById('titleCharCount');
        const contentCharCount = document.getElementById('contentCharCount');
        const viewNoteModal = document.getElementById('viewNoteModal');
        const modalNoteTitle = document.getElementById('modalNoteTitle');
        const modalNoteContent = document.getElementById('modalNoteContent');
        const modalCreatedAt = document.getElementById('modalCreatedAt');
        const modalUpdatedAt = document.getElementById('modalUpdatedAt');
        const modalNoteId = document.getElementById('modalNoteId');
        const modalImageContainer = document.getElementById('modalImageContainer');
        const modalImage = document.getElementById('modalImage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalBtn2 = document.getElementById('closeModalBtn2');
        const copyModalBtn = document.getElementById('copyModalBtn');
        const editFromModalBtn = document.getElementById('editFromModalBtn');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        function showToast(msg, type = 'success') {
            if (!toast || !toastMessage) return;
            toastMessage.textContent = msg;
            toast.className = `toast ${type}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        function updateCharCounts() {
            if (titleCharCount) titleCharCount.textContent = noteTitleInput.value.length;
            if (contentCharCount) contentCharCount.textContent = noteContentInput.value.length;
        }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatDate(ts) { if (!ts) return 'Tidak tersedia'; try { return new Intl.DateTimeFormat('id-ID', { day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' }).format(ts.toDate()); } catch { return 'Baru saja'; } }
        function formatDateShort(ts) { if (!ts) return 'Baru saja'; try { const d = ts.toDate(); const now = new Date(); const mins = Math.floor((now-d)/60000); if (mins<1) return 'Baru saja'; if (mins<60) return mins+' menit lalu'; if (mins<1440) return Math.floor(mins/60)+' jam lalu'; return new Intl.DateTimeFormat('id-ID',{day:'numeric',month:'short'}).format(d); } catch { return 'Baru saja'; } }
        function resetImageForm() {
            noteImageInput.value = '';
            selectedImageFile = null;
            currentImageURL = null;
            imagePreviewContainer.style.display = 'none';
            imagePreview.src = '#';
        }
        function exitEditMode() {
            isEditing = false;
            editingNoteIdInput.value = '';
            noteTitleInput.value = '';
            noteContentInput.value = '';
            formTitle.innerHTML = 'Tambah Catatan Baru';
            formIcon.className = 'fas fa-plus-circle';
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Catatan';
            cancelEditBtn.style.display = 'none';
            updateCharCounts();
            resetImageForm();
        }
        function enterEditMode(id, title, content, imageURL) {
            isEditing = true;
            editingNoteIdInput.value = id;
            noteTitleInput.value = title;
            noteContentInput.value = content;
            currentImageURL = imageURL || null;
            if (imageURL) {
                imagePreview.src = imageURL;
                imagePreviewContainer.style.display = 'block';
            } else {
                imagePreviewContainer.style.display = 'none';
            }
            selectedImageFile = null;
            noteImageInput.value = '';
            formTitle.innerHTML = 'Edit Catatan';
            formIcon.className = 'fas fa-edit';
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Catatan';
            cancelEditBtn.style.display = 'flex';
            updateCharCounts();
            noteTitleInput.focus();
        }

        // Load Firebase modules
        async function loadFirebase() {
            try {
                const firebaseApp = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
                const firebaseFirestore = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const firebaseStorage = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js");
                window.initializeFirebaseApp = firebaseApp.initializeApp;
                window.getFirestore = firebaseFirestore.getFirestore;
                window.collection = firebaseFirestore.collection;
                window.addDoc = firebaseFirestore.addDoc;
                window.onSnapshot = firebaseFirestore.onSnapshot;
                window.deleteDoc = firebaseFirestore.deleteDoc;
                window.doc = firebaseFirestore.doc;
                window.serverTimestamp = firebaseFirestore.serverTimestamp;
                window.query = firebaseFirestore.query;
                window.orderBy = firebaseFirestore.orderBy;
                window.increment = firebaseFirestore.increment;
                window.updateDoc = firebaseFirestore.updateDoc;
                window.getDoc = firebaseFirestore.getDoc;
                window.setDoc = firebaseFirestore.setDoc;
                window.getDocs = firebaseFirestore.getDocs;
                // storage
                window.getStorage = firebaseStorage.getStorage;
                window.ref = firebaseStorage.ref;
                window.uploadBytes = firebaseStorage.uploadBytes;
                window.getDownloadURL = firebaseStorage.getDownloadURL;
                window.deleteObject = firebaseStorage.deleteObject;
                return true;
            } catch (e) { console.error('Error loading Firebase', e); return false; }
        }

        // ========== CRUD dengan GAMBAR ==========
        async function saveNote() {
            const title = noteTitleInput.value.trim();
            const content = noteContentInput.value.trim();
            if (!title) { showToast('Judul tidak boleh kosong', 'error'); noteTitleInput.focus(); return; }
            if (!content) { showToast('Isi catatan tidak boleh kosong', 'error'); noteContentInput.focus(); return; }

            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            let imageURLToSave = currentImageURL;

            // 1. Upload gambar baru jika ada
            if (selectedImageFile) {
                try {
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Upload gambar...';
                    const fileName = `images/${Date.now()}_${selectedImageFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    const storageRef = ref(storageInstance, fileName);
                    await uploadBytes(storageRef, selectedImageFile);
                    imageURLToSave = await getDownloadURL(storageRef);
                } catch (err) {
                    console.error(err);
                    showToast('Gagal upload gambar', 'error');
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    return;
                }
            }

            // 2. Hapus gambar lama jika diganti/dihapus (saat edit)
            if (isEditing && editingNoteIdInput.value) {
                const oldSnap = await getDoc(doc(db, "notes", editingNoteIdInput.value));
                if (oldSnap.exists()) {
                    const oldData = oldSnap.data();
                    if (oldData.imageURL && oldData.imageURL !== imageURLToSave) {
                        try {
                            const oldRef = ref(storageInstance, oldData.imageURL);
                            await deleteObject(oldRef);
                        } catch (e) { console.warn('gagal hapus gambar lama', e); }
                    }
                }
            }

            // 3. Simpan ke Firestore
            try {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (isEditing ? 'Mengupdate...' : 'Menyimpan...');
                const noteData = {
                    title, content,
                    updatedAt: serverTimestamp(),
                    imageURL: imageURLToSave || null
                };
                if (isEditing && editingNoteIdInput.value) {
                    await updateDoc(doc(db, "notes", editingNoteIdInput.value), noteData);
                    showToast('Catatan diperbarui', 'success');
                } else {
                    noteData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "notes"), noteData);
                    showToast('Catatan disimpan', 'success');
                }
                exitEditMode();
                resetImageForm();
            } catch (err) {
                console.error(err);
                showToast('Gagal simpan: ' + err.message, 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Hapus catatan ini?')) return;
            try {
                const noteRef = doc(db, "notes", noteId);
                const snap = await getDoc(noteRef);
                if (snap.exists() && snap.data().imageURL) {
                    try {
                        const imgRef = ref(storageInstance, snap.data().imageURL);
                        await deleteObject(imgRef);
                    } catch (e) { console.warn('gagal hapus gambar', e); }
                }
                await deleteDoc(noteRef);
                if (editingNoteIdInput.value === noteId) exitEditMode();
                showToast('Catatan dihapus', 'success');
            } catch (err) { showToast('Gagal hapus', 'error'); }
        }

        function viewNoteFull(note) {
            currentViewingNote = note;
            modalNoteTitle.textContent = note.title || 'Tanpa Judul';
            modalNoteContent.textContent = note.content || '';
            modalCreatedAt.textContent = note.createdAt ? formatDate(note.createdAt) : '-';
            modalUpdatedAt.textContent = note.updatedAt ? formatDate(note.updatedAt) : '-';
            modalNoteId.textContent = note.id;
            if (note.imageURL) {
                modalImage.src = note.imageURL;
                modalImageContainer.style.display = 'block';
            } else {
                modalImageContainer.style.display = 'none';
            }
            viewNoteModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            viewNoteModal.classList.remove('show');
            currentViewingNote = null;
            document.body.style.overflow = 'auto';
        }

        function displayNotes() {
            const q = query(collection(db, "notes"), orderBy("createdAt", "desc"));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const notes = [];
                snapshot.forEach(d => notes.push({ id: d.id, ...d.data() }));
                notesCount.textContent = notes.length + ' catatan';
                if (totalNotesElement) totalNotesElement.textContent = notes.length;

                if (notes.length === 0) {
                    notesList.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard"></i><h3>Belum ada catatan</h3><p>Tambahkan catatan pertama dengan form di atas.</p></div>';
                    return;
                }

                notesList.innerHTML = '';
                notes.forEach(note => {
                    const card = document.createElement('div');
                    card.className = 'note-card';
                    const isEdited = note.updatedAt && note.createdAt && note.updatedAt.toDate() > note.createdAt.toDate();
                    const dateInfo = isEdited ?
                        `<div class="note-date" title="Diperbarui: ${formatDate(note.updatedAt)}"><i class="fas fa-edit"></i> ${formatDateShort(note.updatedAt)} <span style="margin-left:auto; font-size:0.7rem; color:var(--warning);"><i class="fas fa-pen"></i> diedit</span></div>` :
                        `<div class="note-date" title="Dibuat: ${formatDate(note.createdAt)}"><i class="far fa-calendar"></i> ${formatDateShort(note.createdAt)}</div>`;

                    let imageHtml = '';
                    if (note.imageURL) {
                        imageHtml = `<div style="margin:10px 0 10px 10px;"><img src="${escapeHtml(note.imageURL)}" alt="gambar" class="note-image-thumb" style="max-width:100%; max-height:100px; border-radius:6px; object-fit:cover;"></div>`;
                    }

                    card.innerHTML = `
                        <h3 class="note-title">${escapeHtml(note.title || 'Tanpa Judul')}</h3>
                        <div class="note-content">${escapeHtml((note.content || '').substring(0,120))}${(note.content||'').length>120?'...':''}</div>
                        ${imageHtml}
                        ${dateInfo}
                        <div class="note-actions">
                            <button class="btn btn-info view-btn" data-id="${note.id}"><i class="fas fa-eye"></i> Lihat</button>
                            <button class="btn btn-warning edit-btn" data-id="${note.id}"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-danger delete-btn" data-id="${note.id}"><i class="far fa-trash-alt"></i> Hapus</button>
                        </div>
                    `;
                    notesList.appendChild(card);
                });

                document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', (e) => { e.stopPropagation(); deleteNote(b.dataset.id); }));
                document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const note = notes.find(n => n.id === b.dataset.id);
                    if (note) enterEditMode(note.id, note.title, note.content, note.imageURL);
                }));
                document.querySelectorAll('.view-btn').forEach(b => b.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const note = notes.find(n => n.id === b.dataset.id);
                    if (note) viewNoteFull(note);
                }));
            }, (err) => {
                console.error(err);
                notesList.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-triangle"></i><h3>Gagal memuat</h3><p>${err.message}</p></div>`;
            });
            cleanupFunctions.push(unsubscribe);
        }

        // Inisialisasi app
        async function initializeApp() {
            const loaded = await loadFirebase();
            if (!loaded) { showToast('Gagal muat Firebase', 'error'); return; }
            try {
                app = initializeFirebaseApp(firebaseConfig);
                db = getFirestore(app);
                storageInstance = getStorage(app);
                notesCollection = collection(db, "notes");

                await trackVisit();
                await trackActiveUsers();
                displayNotes();

                noteTitleInput?.addEventListener('input', updateCharCounts);
                noteContentInput?.addEventListener('input', updateCharCounts);
                saveBtn?.addEventListener('click', saveNote);
                cancelEditBtn?.addEventListener('click', exitEditMode);
                clearFormBtn?.addEventListener('click', () => {
                    if (isEditing && confirm('Batalkan edit?')) exitEditMode();
                    else { noteTitleInput.value = ''; noteContentInput.value = ''; resetImageForm(); updateCharCounts(); }
                });

                noteImageInput?.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) { selectedImageFile = null; imagePreviewContainer.style.display = 'none'; return; }
                    if (file.size > 5 * 1024 * 1024) {
                        showToast('Maksimal 5MB', 'error');
                        noteImageInput.value = '';
                        return;
                    }
                    selectedImageFile = file;
                    const reader = new FileReader();
                    reader.onload = (ev) => { imagePreview.src = ev.target.result; imagePreviewContainer.style.display = 'block'; };
                    reader.readAsDataURL(file);
                });

                removeImageBtn?.addEventListener('click', () => {
                    noteImageInput.value = '';
                    selectedImageFile = null;
                    if (isEditing) currentImageURL = null;
                    imagePreviewContainer.style.display = 'none';
                });

                closeModalBtn?.addEventListener('click', closeModal);
                closeModalBtn2?.addEventListener('click', closeModal);
                editFromModalBtn?.addEventListener('click', () => {
                    if (currentViewingNote) {
                        closeModal();
                        enterEditMode(currentViewingNote.id, currentViewingNote.title, currentViewingNote.content, currentViewingNote.imageURL);
                    }
                });
                copyModalBtn?.addEventListener('click', () => {
                    if (currentViewingNote) {
                        navigator.clipboard.writeText(currentViewingNote.content)
                            .then(() => showToast('Teks tersalin', 'success'))
                            .catch(() => showToast('Gagal menyalin', 'error'));
                    }
                });
                viewNoteModal?.addEventListener('click', (e) => { if (e.target === viewNoteModal) closeModal(); });
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && viewNoteModal?.classList.contains('show')) closeModal(); });

                updateCharCounts();
            } catch (err) { console.error('Init error', err); }
        }

        // Statistik
        async function trackVisit() {
            const visitsRef = doc(db, "stats", "visits");
            await updateDoc(visitsRef, { count: increment(1), lastUpdated: serverTimestamp() }).catch(async () => await setDoc(visitsRef, { count: 1, lastUpdated: serverTimestamp() }));
            onSnapshot(visitsRef, (d) => { if (d.exists() && totalVisitsElement) totalVisitsElement.textContent = d.data().count || 1; });
        }
        async function trackActiveUsers() {
            const userId = localStorage.getItem('vault_userId') || 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
            localStorage.setItem('vault_userId', userId);
            const sessionRef = doc(db, "sessions", userId);
            await setDoc(sessionRef, { userId, lastActive: serverTimestamp(), userAgent: navigator.userAgent.substring(0,200), online: true });
            const interval = setInterval(async () => { try { await updateDoc(sessionRef, { lastActive: serverTimestamp() }); } catch { clearInterval(interval); } }, 30000);
            const unsubscribe = onSnapshot(collection(db, "sessions"), (snap) => {
                let active = 0; const now = new Date();
                snap.docs.forEach(d => { if (d.data().lastActive) { const diff = (now - d.data().lastActive.toDate()) / 60000; if (diff < 2) active++; } });
                if (activeUsersElement) activeUsersElement.textContent = Math.max(1, active);
            });
            const cleanup = async () => { clearInterval(interval); await updateDoc(sessionRef, { online: false, lastActive: serverTimestamp() }); unsubscribe(); };
            window.addEventListener('beforeunload', cleanup);
            window.addEventListener('pagehide', cleanup);
            cleanupFunctions.push(cleanup);
        }

        // Bootstrap
        document.addEventListener('DOMContentLoaded', () => {
            generateCryptoParticles();
            setupPasswordToggle();
            setupLogin();
            setupLogout();
            window.addEventListener('resize', generateCryptoParticles);
        });
    </script>
</body>
</html>
